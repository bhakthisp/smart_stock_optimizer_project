<!-- templates/dashboard.html -->
{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col-md-8">
    <h3>Dashboard</h3>
    <p class="text-muted">Welcome, {{ username }} · Role: {{ role }}</p>
  </div>
  <div class="col-md-4 text-end">
    <form method="post" action="{{ url_for('run_forecast') }}">
      <button class="btn btn-success">Run Forecast Now</button>
      <a href="{{ url_for('download_forecast') }}" class="btn btn-outline-primary">Download Latest CSV</a>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-4">
    <div class="card p-2">
      <h6>Alerts</h6>
      <p>Total understock: <strong>{{ summary.total_understock or 0 }}</strong></p>
      <p>Total overstock: <strong>{{ summary.total_overstock or 0 }}</strong></p>
      <a href="{{ url_for('alerts') }}" class="btn btn-sm btn-warning">View details</a>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-2">
      <h6>Top Understock Products</h6>
      <div id="prodBar" style="height:220px">
        {% if not prod_names %}
          <p class="text-muted text-center mt-5">No data available</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-2">
      <h6>Stores with Most Shortages</h6>
      <div id="storeBar" style="height:220px">
        {% if not store_labels %}
          <p class="text-muted text-center mt-5">No data available</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-12">
    <div class="card p-3">
      <h6>Forecast Preview</h6>
      <div class="table-responsive">
        {% if preview_table %}
          {{ preview_table | safe }}
        {% else %}
          <p class="text-muted text-center">No forecast data to display.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // SAFELY parse Jinja → JS, fallback to empty arrays if None or invalid
    let prodNames = [];
    let prodCounts = [];
    let storeLabels = [];
    let storeCounts = [];

    try {
        prodNames = JSON.parse('{{ prod_names | tojson | safe | replace("None", "[]") }}');
        prodCounts = JSON.parse('{{ prod_counts | tojson | safe | replace("None", "[]") }}');
        storeLabels = JSON.parse('{{ store_labels | tojson | safe | replace("None", "[]") }}');
        storeCounts = JSON.parse('{{ store_counts | tojson | safe | replace("None", "[]") }}');
    } catch(e) {
        console.warn("Chart data not available, using empty arrays.", e);
    }

    // Plot - Top Products
    if (prodNames.length && prodCounts.length) {
        Plotly.newPlot('prodBar', [{
            x: prodNames,
            y: prodCounts,
            type: 'bar',
            marker: { color: 'rgb(0,123,255)' }
        }], { margin: { t: 30 }, responsive: true });
    } else {
        document.getElementById('prodBar').innerHTML = "<p class='text-center text-muted mt-5'>No data available</p>";
    }

    // Plot - Stores Shortages
    if (storeLabels.length && storeCounts.length) {
        Plotly.newPlot('storeBar', [{
            x: storeLabels,
            y: storeCounts,
            type: 'bar',
            marker: { color: 'rgb(255,99,71)' }
        }], { margin: { t: 30 }, responsive: true });
    } else {
        document.getElementById('storeBar').innerHTML = "<p class='text-center text-muted mt-5'>No data available</p>";
    }
</script>
{% endblock %}
